name: Release
on:
  push:
    branches:
      - main
      - beta
      - mc/update-kotlin-gh-action-reverted  # Temporary for testing

jobs:
  js:
    name: Release (JS)
    permissions:
      id-token: write
      contents: write
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".node-version"
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm run semantic-release

  kotlin:
    needs: js
    if: ${{ github.ref_name == 'main' || github.ref_name == 'mc/update-kotlin-gh-action-reverted' }}  # Temporary for testing
    name: Release (Kotlin)
    permissions:
      id-token: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project sources
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          validate-wrappers: true
          cache-read-only: false

      - name: Generate protobufs
        run: dev/kotlin/generate

      - name: Run build with Gradle Wrapper
        run: ./gradlew build

      - name: Set Tag
        id: set-tag
        run: |
          git fetch --tags --prune
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "::error::No git tag found. Cannot determine release version."
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "GIT_TAG=${VERSION}" >> $GITHUB_ENV
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION}"

      - name: Gradle Publish
        env:
          RELEASE_VERSION: ${{ env.GIT_TAG }}
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.OSSRH_GPG_SECRET_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.OSSRH_GPG_SECRET_KEY_PASSWORD }}
          MAVEN_PROFILE_ID: ${{ secrets.MAVEN_PROFILE_ID }}
        run: |
          if [ -z "$RELEASE_VERSION" ]; then
            echo "::error::RELEASE_VERSION is empty"
            exit 1
          fi
          echo "Publishing version: $RELEASE_VERSION to Maven Central"
          ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository --info --stacktrace